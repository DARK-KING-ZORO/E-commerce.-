<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root { --admin-primary: #343a40; --admin-secondary: #f8f9fa; --admin-accent: #007bff; --admin-text: #333; --admin-light-text: #f8f9fa; --font-family: 'Poppins', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: #f4f7f6; color: var(--admin-text); }
        .admin-wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: var(--admin-primary); color: var(--admin-light-text); transition: width 0.3s; }
        .sidebar-header { padding: 20px; text-align: center; font-size: 1.5rem; font-weight: 600; border-bottom: 1px solid #495057; }
        .sidebar-nav { list-style: none; padding: 20px 0; }
        .sidebar-nav a { display: flex; align-items: center; padding: 15px 20px; color: var(--admin-light-text); text-decoration: none; transition: background-color 0.2s; position: relative; }
        .sidebar-nav a.active, .sidebar-nav a:hover { background-color: #495057; }
        .sidebar-nav a i { margin-right: 15px; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; padding: 20px; overflow-x: auto; }
        .admin-page { display: none; }
        .admin-page.active { display: block; }
        #login-screen { display: flex; justify-content: center; align-items: center; height: 100vh; width: 100%; background-color: #f4f7f6; }
        #login-box { padding: 40px; background: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 90%; max-width: 400px; }
        #login-box h2 { text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; width: 100%; margin-bottom: 5px; font-weight: 500; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: var(--admin-accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        #admin-login-error { color: red; text-align: center; margin-top: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; }
        .stat-card h3 { color: #6c757d; font-size: 1rem; }
        .stat-card .count { font-size: 2.5rem; font-weight: 600; color: var(--admin-primary); }
        .settings-card, .form-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px;}
        .settings-card h2, .form-card h2 { margin-bottom: 15px; }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-add { background-color: #28a745; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; border: none; width: auto; }
        .data-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .data-table th, .data-table td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; vertical-align: middle; }
        .data-table th { background-color: #f8f9fa; }
        .data-table img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .action-btns button { margin: 2px; padding: 5px 10px; font-size: 0.9rem; width: auto; border-radius: 4px; border: none; color: white; cursor: pointer; }
        .btn-edit { background-color: #ffc107; }
        .btn-delete, .btn-archive { background-color: #dc3545; }
        .btn-view-address { background-color: #007bff; }
        .btn-view-items { background-color: #17a2b8; }
        .btn-approve-payment { background-color: #28a745; }
        .status-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; width: auto; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        #modal-address-content { margin-top: 15px; line-height: 1.6; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #28a745; }
        input:checked + .slider:before { transform: translateX(26px); }
        .notification-badge { position: absolute; top: 10px; right: 10px; background-color: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8em; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        #chat-modal .chat-container { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; }
        #chat-modal .chat-message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        #chat-modal .user-message { background-color: #e9ecef; align-self: flex-start; }
        #chat-modal .admin-message { background-color: #d1ecf1; align-self: flex-end; }
        #chat-modal .chat-input { display: flex; }
        #chat-modal .chat-input input { flex-grow: 1; }
        #chat-modal .chat-input button { width: auto; margin-left: 10px; }
        .star-rating { color: #ffc107; }
        .payment-info { font-size: 0.85em; color: #555; margin-top: 5px; }
        @media (max-width: 768px) { .admin-wrapper { flex-direction: column; } .sidebar { width: 100%; height: auto; } .sidebar-header { display: none; } .sidebar-nav { display: flex; justify-content: space-around; width: 100%; padding: 0; } .sidebar-nav a { padding: 15px 10px; justify-content: center; } .sidebar-nav a .nav-text { display: none; } .sidebar-nav a i { margin-right: 0; } .main-content { padding: 15px; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-box">
            <h2>Admin Login</h2>
            <form id="admin-login-form">
                <div class="form-group"><input type="email" id="admin-email" placeholder="Email" required></div>
                <div class="form-group"><input type="password" id="admin-password" placeholder="Password" required></div>
                <button type="submit">Login</button>
            </form>
            <div id="admin-login-error"></div>
        </div>
    </div>

    <div class="admin-wrapper" id="admin-dashboard-wrapper" style="display: none;">
        <nav class="sidebar">
            <div class="sidebar-header">Admin Panel</div>
            <ul class="sidebar-nav">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> <span class="nav-text">Dashboard</span></a></li>
                <li><a href="#products" class="nav-link"><i class="fas fa-box-open"></i> <span class="nav-text">Products</span></a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-receipt"></i> <span class="nav-text">Orders</span></a></li>
                <li><a href="#user-coupons" class="nav-link"><i class="fas fa-gift"></i> <span class="nav-text">User Coupons</span></a></li>
                <li><a href="#slider" class="nav-link"><i class="fas fa-images"></i> <span class="nav-text">Slider</span></a></li>
                <li><a href="#ratings" class="nav-link"><i class="fas fa-star"></i> <span class="nav-text">Ratings</span></a></li>
                <li><a href="#chats" class="nav-link"><i class="fas fa-comments"></i> <span class="nav-text">Chats</span><span id="chat-notification-badge" class="notification-badge" style="display: none;">0</span></a></li>
                <li><a href="#" id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> <span class="nav-text">Logout</span></a></li>
            </ul>
        </nav>

        <main class="main-content">
            <section id="dashboard" class="admin-page active">
                <h1>Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card"><h3>Total Products</h3><p class="count" id="total-products">0</p></div>
                    <div class="stat-card"><h3>Total Orders</h3><p class="count" id="total-orders">0</p></div>
                    <div class="stat-card"><h3>Total Users</h3><p class="count" id="total-users">0</p></div>
                </div>
                <div class="settings-card">
                    <h2>Shop Settings</h2>
                    <form id="shop-settings-form">
                        <div class="form-group"><label for="shop-name-input">Shop Name</label><input type="text" id="shop-name-input" placeholder="Enter Shop Name" required></div>
                        <button type="submit">Save Name</button>
                    </form>
                </div>
                 <div class="settings-card">
                    <h2>App Promotion Settings</h2>
                    <form id="app-settings-form">
                        <div class="form-group"><label for="app-image-url-input">App Image URL (e.g., QR Code)</label><input type="url" id="app-image-url-input" placeholder="https://example.com/app-image.png"></div>
                        <div class="form-group"><label for="app-download-url-input">App Download URL</label><input type="url" id="app-download-url-input" placeholder="https://play.google.com/store/apps/details?id=..."></div>
                        <button type="submit">Save Settings</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h2>UPI Payment Settings</h2>
                    <form id="upi-settings-form">
                        <div class="form-group"><label for="upi-id-input">Your UPI ID</label><input type="text" id="upi-id-input" placeholder="e.g., yourname@upi" required></div>
                        <div class="form-group"><label for="upi-qrcode-url-input">UPI QR Code Image URL</label><input type="url" id="upi-qrcode-url-input" placeholder="https://example.com/qr.png" required></div>
                        <button type="submit">Save UPI Settings</button>
                    </form>
                </div>
            </section>
            <section id="products" class="admin-page"><div class="content-header"><h1>Manage Products</h1><button class="btn-add" id="add-product-btn">Add New Product</button></div><table class="data-table"><thead><tr><th>Image</th><th>Name</th><th>Price</th><th>Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></section>
            <section id="orders" class="admin-page"><h1>Manage Orders</h1><table class="data-table"><thead><tr><th>Order Details</th><th>Customer</th><th>Date / Total</th><th>Payment / Status</th><th>Actions</th></tr></thead><tbody id="orders-table-body"></tbody></table></section>
            <section id="user-coupons" class="admin-page">
                <h1>Manage Public Coupons</h1>
                <div class="form-card">
                    <h2>Add New Coupon for Users</h2>
                    <form id="public-coupon-form">
                        <div class="form-group"><label for="public-coupon-code">Coupon Code</label><input type="text" id="public-coupon-code" placeholder="e.g., DIWALI20" required></div>
                        <div class="form-group"><label for="public-coupon-discount">Discount (%)</label><input type="number" id="public-coupon-discount" placeholder="e.g., 20" required></div>
                        <div class="form-group"><label for="public-coupon-desc">Description</label><input type="text" id="public-coupon-desc" placeholder="e.g., Diwali Special Offer" required></div>
                        <button type="submit">Add Coupon</button>
                    </form>
                </div>
                <table class="data-table"><thead><tr><th>Code</th><th>Discount</th><th>Description</th><th>Status</th><th>Actions</th></tr></thead><tbody id="public-coupons-table-body"></tbody></table>
            </section>
            <section id="slider" class="admin-page"><div class="content-header"><h1>Manage Slider Images</h1><button class="btn-add" id="add-slider-image-btn">Add New Image</button></div><table class="data-table"><thead><tr><th>Image Preview</th><th>Image URL</th><th>Linked Product</th><th>Actions</th></tr></thead><tbody id="slider-table-body"></tbody></table></section>
            <section id="ratings" class="admin-page"><h1>Product Ratings & Reviews</h1><table class="data-table"><thead><tr><th>Product</th><th>User</th><th>Rating</th><th>Review</th><th>Status</th></tr></thead><tbody id="ratings-table-body"></tbody></table></section>
            <section id="chats" class="admin-page"><h1>User Messages</h1><table class="data-table"><thead><tr><th>Order ID</th><th>User Email</th><th>Last Message</th><th>Date</th><th>Actions</th></tr></thead><tbody id="chats-table-body"></tbody></table></section>
        </main>
    </div>

    <!-- Modals -->
    <div id="product-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="product-modal-title">Add Product</h2><form id="product-form"><input type="hidden" id="product-id">
        <div class="form-group"><label>Product Name</label><input type="text" id="product-name" required></div>
        <div class="form-group"><label>Category</label><input type="text" id="product-category" required></div>
        <div class="form-group"><label>Original Price (â‚¹)</label><input type="number" id="product-original-price" step="0.01" required></div>
        <div class="form-group"><label>Discount Percentage (%)</label><input type="number" id="product-discount" step="1" placeholder="e.g., 10 for 10% OFF"></div>
        <div class="form-group"><label>Description</label><textarea id="product-description" rows="4"></textarea></div>
        <div class="form-group"><label>Main Image URL</label><input type="url" id="product-image-url" required></div>
        <div class="form-group"><label>Additional Image URL 2 (Optional)</label><input type="url" id="product-image-url-2"></div>
        <div class="form-group"><label>Additional Image URL 3 (Optional)</label><input type="url" id="product-image-url-3"></div>
        <div class="form-group"><label>Additional Image URL 4 (Optional)</label><input type="url" id="product-image-url-4"></div>
        <div class="form-group"><label>Additional Image URL 5 (Optional)</label><input type="url" id="product-image-url-5"></div>
        <div class="form-group"><label>Stock Status</label><select id="product-stock-status"><option value="true">In Stock</option><option value="false">Out of Stock</option></select></div>
        <div class="form-group"><label>Availability Text (Optional)</label><input type="text" id="product-availability-text" placeholder="e.g., Available, Only 2 left!"></div>
        <button type="submit">Save Product</button></form></div></div>
    <div id="slider-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Add Slider Image</h2><form id="slider-form"><div class="form-group"><label>Image URL</label><input type="url" id="slider-image-url" required></div><div class="form-group"><label>Link to Product (Optional)</label><select id="slider-product-link"></select><img id="slider-product-preview-img" src="" alt="Product Preview" style="display: none; max-width: 80px; max-height: 80px; margin-top: 10px; border-radius: 4px; border: 1px solid #ddd;"></div><button type="submit">Add Image</button></form></div></div>
    <div id="address-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Shipping Address</h2><div id="modal-address-content"></div></div></div>
    <div id="order-items-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Order Items</h2><table class="data-table"><thead><tr><th>Image</th><th>Product</th><th>Quantity</th><th>Price</th></tr></thead><tbody id="order-items-table-body"></tbody></table></div></div>
    <div id="chat-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="chat-modal-title">Chat with User</h2><div class="chat-container" id="chat-container"></div><div class="chat-input"><input type="text" id="chat-reply-input" placeholder="Type your reply..."><button id="send-reply-btn">Send</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCJzmlC2dVFU8Zo4W834K3ryih4FHQH50U",
          authDomain: "earn-pro-web.firebaseapp.com",
          databaseURL: "https://earn-pro-web-default-rtdb.firebaseio.com",
          projectId: "earn-pro-web",
          storageBucket: "earn-pro-web.firebasestorage.app",
          messagingSenderId: "283143670782",
          appId: "1:283143670782:web:c0b223fc14a2d1b40bceaf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        const loginScreen = document.getElementById('login-screen');
        const dashboardWrapper = document.getElementById('admin-dashboard-wrapper');
        const loginErrorDiv = document.getElementById('admin-login-error');
        let allProducts = [];
        let allOrders = [];
        let allUsers = {};
        let chatListener = null;

        onAuthStateChanged(auth, user => { if (user) { loginScreen.style.display = 'none'; dashboardWrapper.style.display = 'flex'; initAdminPanel(); } else { loginScreen.style.display = 'flex'; dashboardWrapper.style.display = 'none'; } });
        document.getElementById('admin-login-form').addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('admin-email').value; const password = document.getElementById('admin-password').value; loginErrorDiv.textContent = ''; signInWithEmailAndPassword(auth, email, password).catch(error => { loginErrorDiv.textContent = 'Invalid email or password.'; }); });
        document.getElementById('admin-logout-btn').addEventListener('click', () => signOut(auth));
        const adminPages = document.querySelectorAll('.admin-page'); const navLinks = document.querySelectorAll('.nav-link'); const navigateAdmin = (hash) => { const targetId = (hash) ? hash.substring(1) : 'dashboard'; adminPages.forEach(p => p.classList.toggle('active', p.id === targetId)); navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash || (hash === '' && l.getAttribute('href') === '#dashboard'))); };
        window.addEventListener('hashchange', () => navigateAdmin(location.hash)); window.addEventListener('DOMContentLoaded', () => navigateAdmin(location.hash || '#dashboard')); navLinks.forEach(link => { if (link.getAttribute('href') && link.getAttribute('href') !== '#') { link.addEventListener('click', (e) => { e.preventDefault(); location.hash = link.getAttribute('href'); }); } });

        const initAdminPanel = () => {
            onValue(ref(db, 'products'), s => { allProducts = s.exists() ? Object.entries(s.val()).map(([id, data]) => ({ id, ...data })) : []; document.getElementById('total-products').textContent = allProducts.length; loadProducts(); loadOrders(); loadSliderImages(); loadRatings(); });
            onValue(ref(db, 'orders'), s => {
                allOrders = [];
                if(s.exists()){
                    s.forEach(userSnapshot => {
                        const userId = userSnapshot.key;
                        userSnapshot.forEach(orderSnapshot => { allOrders.push({ userId, orderId: orderSnapshot.key, ...orderSnapshot.val() }); });
                    });
                }
                loadDashboardStats();
                loadOrders();
            });
             onValue(ref(db, 'users'), s => {
                allUsers = s.exists() ? s.val() : {};
                loadDashboardStats();
            });
            loadSliderImages(); 
            loadShopSettings();
            loadAppSettings();
            loadUpiSettings();
            loadPublicCoupons();
            loadRatings();
            loadChats();
        };

        const loadShopSettings = () => { const shopNameInput = document.getElementById('shop-name-input'); onValue(ref(db, 'settings/shopName'), (snapshot) => { if(snapshot.exists()) { shopNameInput.value = snapshot.val(); } }); };
        document.getElementById('shop-settings-form').addEventListener('submit', (e) => { e.preventDefault(); const newShopName = document.getElementById('shop-name-input').value; set(ref(db, 'settings/shopName'), newShopName).then(() => alert('Shop name updated successfully!')).catch((error) => alert('Error: ' + error.message)); });
        
        const loadAppSettings = () => {
            const imageInput = document.getElementById('app-image-url-input');
            const downloadInput = document.getElementById('app-download-url-input');
            onValue(ref(db, 'settings/appPromotion'), (snapshot) => {
                if(snapshot.exists()) {
                    const data = snapshot.val();
                    imageInput.value = data.imageUrl || '';
                    downloadInput.value = data.downloadUrl || '';
                }
            });
        };
        document.getElementById('app-settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const imageUrl = document.getElementById('app-image-url-input').value;
            const downloadUrl = document.getElementById('app-download-url-input').value;
            const appData = { imageUrl, downloadUrl };
            set(ref(db, 'settings/appPromotion'), appData).then(() => alert('App promotion settings saved!')).catch((error) => alert('Error: ' + error.message));
        });

        const loadUpiSettings = () => {
            const upiIdInput = document.getElementById('upi-id-input');
            const qrCodeUrlInput = document.getElementById('upi-qrcode-url-input');
            onValue(ref(db, 'settings/upiDetails'), (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    upiIdInput.value = data.upiId || '';
                    qrCodeUrlInput.value = data.qrCodeUrl || '';
                }
            });
        };
        document.getElementById('upi-settings-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const upiId = document.getElementById('upi-id-input').value;
            const qrCodeUrl = document.getElementById('upi-qrcode-url-input').value;
            const upiData = { upiId, qrCodeUrl };
            set(ref(db, 'settings/upiDetails'), upiData).then(() => alert('UPI settings saved successfully!')).catch((error) => alert('Error: ' + error.message));
        });


        const loadDashboardStats = () => {
            document.getElementById('total-orders').textContent = allOrders.length;
            document.getElementById('total-users').textContent = Object.keys(allUsers).length;
        };
        
        const productModal = document.getElementById('product-modal'); const productForm = document.getElementById('product-form'); let currentEditingProductId = null;
        
        const loadProducts = () => {
            const tableBody = document.getElementById('products-table-body');
            tableBody.innerHTML = '';
            allProducts.forEach(product => {
                const row = document.createElement('tr');
                let priceHTML = `<b>â‚¹${parseFloat(product.price).toFixed(2)}</b>`;
                if(product.discountPercentage > 0) {
                    priceHTML += ` <s style="color:grey; font-size:0.9em; margin-left: 8px;">â‚¹${parseFloat(product.originalPrice).toFixed(2)}</s>`;
                }
                row.innerHTML = `<td><img src="${product.imageUrl}" alt="${product.name}"></td><td>${product.name}</td><td>${priceHTML}</td><td class="action-btns"><button class="btn-edit">Edit</button><button class="btn-delete">Delete</button></td>`;
                row.querySelector('.btn-edit').addEventListener('click', () => openProductModal(product.id, product));
                row.querySelector('.btn-delete').addEventListener('click', () => deleteProduct(product.id));
                tableBody.appendChild(row);
            });
        };
        
        const openProductModal = (productId = null, product = {}) => {
            currentEditingProductId = productId;
            document.getElementById('product-modal-title').textContent = productId ? 'Edit Product' : 'Add Product';
            productForm.reset();
            if (productId) {
                document.getElementById('product-id').value = productId;
                document.getElementById('product-name').value = product.name || '';
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-original-price').value = product.originalPrice || '';
                document.getElementById('product-discount').value = product.discountPercentage || '';
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-image-url').value = product.imageUrl || '';
                document.getElementById('product-image-url-2').value = product.imageUrl2 || '';
                document.getElementById('product-image-url-3').value = product.imageUrl3 || '';
                document.getElementById('product-image-url-4').value = product.imageUrl4 || '';
                document.getElementById('product-image-url-5').value = product.imageUrl5 || '';
                document.getElementById('product-stock-status').value = product.stockStatus === false ? 'false' : 'true';
                document.getElementById('product-availability-text').value = product.availabilityText || '';
            }
            productModal.classList.add('active');
        };

        const deleteProduct = (productId) => { if(confirm('Are you sure you want to permanently delete this product?')) { remove(ref(db, `products/${productId}`)); } };
        document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
        
        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const originalPrice = parseFloat(document.getElementById('product-original-price').value);
            const discountPercentage = parseFloat(document.getElementById('product-discount').value) || 0;
            let finalPrice = originalPrice;
            if (discountPercentage > 0 && discountPercentage <= 100) {
                finalPrice = originalPrice - (originalPrice * (discountPercentage / 100));
            }
            const productData = { 
                name: document.getElementById('product-name').value, 
                category: document.getElementById('product-category').value, 
                originalPrice: originalPrice, 
                discountPercentage: discountPercentage, 
                price: finalPrice, 
                description: document.getElementById('product-description').value, 
                imageUrl: document.getElementById('product-image-url').value, 
                imageUrl2: document.getElementById('product-image-url-2').value, 
                imageUrl3: document.getElementById('product-image-url-3').value, 
                imageUrl4: document.getElementById('product-image-url-4').value,
                imageUrl5: document.getElementById('product-image-url-5').value,
                stockStatus: document.getElementById('product-stock-status').value === 'true',
                availabilityText: document.getElementById('product-availability-text').value
            };
            const productRef = currentEditingProductId ? ref(db, `products/${currentEditingProductId}`) : push(ref(db, 'products'));
            set(productRef, productData).then(() => productModal.classList.remove('active'));
        });
        
        const loadOrders = () => {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = '';
            const visibleOrders = allOrders.filter(order => order.isVisibleToAdmin !== false);
            visibleOrders.sort((a, b) => b.date - a.date);
            visibleOrders.forEach(order => {
                const totalItems = Object.values(order.items).reduce((sum, item) => sum + item.quantity, 0);
                const row = document.createElement('tr');
                
                let paymentHTML = `<div class="payment-info"><b>Method:</b> ${order.paymentMethod || 'N/A'}</div>`;
                let statusControlHTML = `<select class="status-select">
                        <option value="Pending">Pending</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Out for Delivery">Out for Delivery</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>`;

                if (order.paymentMethod === 'UPI' && order.status === 'Waiting for Payment Confirmation') {
                    paymentHTML += `<div class="payment-info"><b>UTR:</b> ${order.transactionId}</div>`;
                    statusControlHTML = `<button class="btn-approve-payment">Approve Payment</button>`;
                } else if(order.status === 'Waiting for Payment Confirmation') {
                    statusControlHTML = `<span style="color: #ffc107; font-weight: bold;">Waiting...</span>`;
                }


                row.innerHTML = `
                    <td>
                        <b>#${order.displayOrderId}</b><br>
                        ${totalItems} item${totalItems > 1 ? 's' : ''}
                        <button class="btn-view-items" style="font-size: 0.8em; padding: 4px 8px; margin-top: 5px;">View Items</button>
                    </td>
                    <td>${order.userEmail}<br><small>${order.shippingAddress.name}</small></td>
                    <td>
                        ${new Date(order.date).toLocaleDateString()}<br>
                        <b>â‚¹${order.totalAmount.toFixed(2)}</b>
                    </td>
                    <td>
                        ${paymentHTML}
                        <div style="margin-top: 10px;">${statusControlHTML}</div>
                    </td>
                    <td class="action-btns">
                        <button class="btn-view-address">Address</button>
                        <button class="btn-archive">Archive</button>
                    </td>`;
                
                if (row.querySelector('.status-select')) {
                    const statusSelect = row.querySelector('.status-select');
                    statusSelect.value = order.status;
                    statusSelect.addEventListener('change', (e) => updateOrderStatus(order.userId, order.orderId, e.target.value, order));
                }
                 if (row.querySelector('.btn-approve-payment')) {
                    row.querySelector('.btn-approve-payment').addEventListener('click', () => approveUpiPayment(order.userId, order.orderId));
                }

                row.querySelector('.btn-view-items').addEventListener('click', () => openOrderItemsModal(order.items));
                row.querySelector('.btn-view-address').addEventListener('click', () => openAddressModal(order.shippingAddress));
                row.querySelector('.btn-archive').addEventListener('click', () => archiveOrder(order.userId, order.orderId));
                tableBody.appendChild(row);
            });
        };
        
        const approveUpiPayment = (userId, orderId) => {
            if (confirm('Are you sure you have received the payment for this order?')) {
                update(ref(db, `orders/${userId}/${orderId}`), { status: 'Pending' });
            }
        };

        const openOrderItemsModal = (items) => {
            const modal = document.getElementById('order-items-modal');
            const tableBody = document.getElementById('order-items-table-body');
            tableBody.innerHTML = '';

            for (const productId in items) {
                const item = items[productId];
                const productDetails = allProducts.find(p => p.id === productId);

                if (productDetails) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${productDetails.imageUrl}" alt="${productDetails.name}"></td>
                        <td>${productDetails.name}</td>
                        <td>${item.quantity}</td>
                        <td>â‚¹${((item.priceAtOrder || productDetails.price) * item.quantity).toFixed(2)}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            modal.classList.add('active');
        };

        const updateOrderStatus = (userId, orderId, newStatus, order) => {
            const updates = { status: newStatus };
            if (newStatus === 'Shipped' && !order.shippedDate) { updates.shippedDate = Date.now(); }
            if (newStatus === 'Out for Delivery' && !order.outForDeliveryDate) { updates.outForDeliveryDate = Date.now(); }
            if (newStatus === 'Delivered' && !order.deliveredDate) { updates.deliveredDate = Date.now(); }
            update(ref(db, `orders/${userId}/${orderId}`), updates);
        };

        const archiveOrder = (userId, orderId) => {
            if(confirm('Archive this order? It will be hidden from this list but remain visible to the user.')) {
                update(ref(db, `/orders/${userId}/${orderId}`), { isVisibleToAdmin: false });
            }
        };

        const addressModal = document.getElementById('address-modal');
        const openAddressModal = (address) => { const contentDiv = document.getElementById('modal-address-content'); if (address) { contentDiv.innerHTML = `<strong>Name:</strong> ${address.name || 'N/A'}<br><strong>Phone:</strong> ${address.phone || 'N/A'}<br><hr style="margin: 10px 0;"><strong>Address:</strong><br>${address.fullAddress || 'N/A'}<br>${address.landmark || ''}<br>${address.city || ''}, ${address.state || ''} - ${address.pincode || ''}<br>${address.country || ''}`; } else { contentDiv.innerHTML = 'Address details not available.'; } addressModal.classList.add('active'); };
        
        const loadPublicCoupons = () => {
            onValue(ref(db, 'publicCoupons'), (snapshot) => {
                const tableBody = document.getElementById('public-coupons-table-body');
                tableBody.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const couponId = childSnapshot.key;
                        const data = childSnapshot.val();
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${data.code}</td><td>${data.discount}%</td><td>${data.description}</td>
                        <td>
                          <label class="switch">
                            <input type="checkbox" class="status-toggle" ${data.isActive ? 'checked' : ''}>
                            <span class="slider"></span>
                          </label>
                        </td>
                        <td class="action-btns"><button class="btn-delete">Delete</button></td>`;
                        row.querySelector('.btn-delete').addEventListener('click', () => deletePublicCoupon(couponId, data.code));
                        row.querySelector('.status-toggle').addEventListener('change', (e) => toggleCouponStatus(couponId, e.target.checked));
                        tableBody.appendChild(row);
                    });
                }
            });
        };

        document.getElementById('public-coupon-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const code = document.getElementById('public-coupon-code').value.toUpperCase();
            const discount = parseInt(document.getElementById('public-coupon-discount').value);
            const description = document.getElementById('public-coupon-desc').value;

            if(code && description && discount > 0 && discount <= 100) {
                const publicCouponRef = push(ref(db, 'publicCoupons'));
                set(publicCouponRef, { code, discount, description, isActive: true });
                set(ref(db, `coupons/${code}`), { percentage: discount });
                alert('Public coupon added!');
                e.target.reset();
            } else {
                alert('Please fill all fields with valid data.');
            }
        });

        const deletePublicCoupon = (couponId, code) => {
            if(confirm(`Delete coupon "${code}"? Users will no longer see it or be able to use it.`)) {
                remove(ref(db, `publicCoupons/${couponId}`));
                remove(ref(db, `coupons/${code}`));
            }
        };

        const toggleCouponStatus = (couponId, isActive) => {
            update(ref(db, `publicCoupons/${couponId}`), { isActive: isActive });
        };

        const loadRatings = () => {
            onValue(ref(db, 'ratings'), (snapshot) => {
                const tableBody = document.getElementById('ratings-table-body');
                tableBody.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(productSnapshot => {
                        const productId = productSnapshot.key;
                        const product = allProducts.find(p => p.id === productId);
                        if (product) {
                            productSnapshot.forEach(ratingSnapshot => {
                                const ratingId = ratingSnapshot.key;
                                const rating = ratingSnapshot.val();
                                const row = document.createElement('tr');
                                const stars = 'â˜…'.repeat(rating.rating) + 'â˜†'.repeat(5 - rating.rating);
                                row.innerHTML = `
                                    <td><img src="${product.imageUrl}" alt="${product.name}" style="vertical-align: middle; margin-right: 10px;">${product.name}</td>
                                    <td>${rating.userEmail}</td>
                                    <td class="star-rating">${stars}</td>
                                    <td>${rating.review}</td>
                                    <td>
                                        <label class="switch">
                                            <input type="checkbox" class="status-toggle" ${rating.active ? 'checked' : ''}>
                                            <span class="slider"></span>
                                        </label>
                                    </td>
                                `;
                                row.querySelector('.status-toggle').addEventListener('change', (e) => toggleRatingStatus(productId, ratingId, e.target.checked));
                                tableBody.appendChild(row);
                            });
                        }
                    });
                }
            });
        };

        const toggleRatingStatus = (productId, ratingId, isActive) => {
            update(ref(db, `ratings/${productId}/${ratingId}`), { active: isActive });
        };


        const sliderModal = document.getElementById('slider-modal');
        const loadSliderImages = () => {
            onValue(ref(db, 'sliderImages'), snapshot => {
                const tableBody = document.getElementById('slider-table-body');
                tableBody.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const imageId = childSnapshot.key;
                        const image = childSnapshot.val();
                        const linkedProduct = allProducts.find(p => p.id === image.productId);
                        const linkedProductName = linkedProduct ? linkedProduct.name : '<em>None</em>';
                        tableBody.innerHTML += `<tr><td><img src="${image.downloadURL}" alt="Slider"></td><td>${image.downloadURL}</td><td>${linkedProductName}</td><td class="action-btns"><button class="btn-delete" data-id="${imageId}">Delete</button></td></tr>`;
                    });
                }
            });
        };

        document.getElementById('add-slider-image-btn').addEventListener('click', () => {
            const productSelect = document.getElementById('slider-product-link');
            const previewImg = document.getElementById('slider-product-preview-img');
            
            productSelect.innerHTML = '<option value="">-- No Link --</option>';
            allProducts.forEach(product => {
                productSelect.innerHTML += `<option value="${product.id}">${product.name}</option>`;
            });
            
            previewImg.style.display = 'none';
            previewImg.src = '';
            
            if (!productSelect.onchange) {
                productSelect.onchange = (e) => {
                    const selectedProductId = e.target.value;
                    if (selectedProductId) {
                        const selectedProduct = allProducts.find(p => p.id === selectedProductId);
                        if (selectedProduct) {
                            previewImg.src = selectedProduct.imageUrl;
                            previewImg.style.display = 'block';
                        }
                    } else {
                        previewImg.style.display = 'none';
                        previewImg.src = '';
                    }
                };
            }

            sliderModal.classList.add('active');
        });

        document.getElementById('slider-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const url = document.getElementById('slider-image-url').value;
            const productId = document.getElementById('slider-product-link').value;
            
            const sliderData = { downloadURL: url };
            if (productId) {
                sliderData.productId = productId;
            }

            push(ref(db, 'sliderImages'), sliderData).then(() => {
                e.target.reset();
                sliderModal.classList.remove('active');
            });
        });

        document.getElementById('slider-table-body').addEventListener('click', e => {
            if (e.target.classList.contains('btn-delete')) {
                if(confirm('Are you sure?')) remove(ref(db, `sliderImages/${e.target.dataset.id}`));
            }
        });

        let currentChatId = null;
        let activeChatListener = null;
        const chatModal = document.getElementById('chat-modal');

        const loadChats = () => {
            const chatsRef = ref(db, 'chats');
            onValue(chatsRef, (snapshot) => {
                const tableBody = document.getElementById('chats-table-body');
                tableBody.innerHTML = '';
                let unreadCount = 0;
                if (snapshot.exists()) {
                    const chats = [];
                    snapshot.forEach(child => {
                        chats.push({ id: child.key, ...child.val() });
                    });
                    
                    chats.sort((a, b) => b.lastUpdated - a.lastUpdated);

                    chats.forEach(chatData => {
                        if (!chatData.isReadByAdmin) unreadCount++;
                        const messagesArray = Object.values(chatData.messages || {});
                        const lastMessage = messagesArray[messagesArray.length - 1];
                        const row = document.createElement('tr');
                        row.style.fontWeight = chatData.isReadByAdmin ? 'normal' : 'bold';
                        row.innerHTML = `
                            <td>#${chatData.displayOrderId}</td>
                            <td>${chatData.userEmail}</td>
                            <td>${lastMessage.text.substring(0, 30)}...</td>
                            <td>${new Date(lastMessage.timestamp).toLocaleString()}</td>
                            <td class="action-btns"><button class="btn-view-items">View Chat</button></td>`;
                        row.querySelector('.btn-view-items').addEventListener('click', () => openChatModal(chatData.id, chatData));
                        tableBody.appendChild(row);
                    });
                }
                const badge = document.getElementById('chat-notification-badge');
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            });
        };

        const openChatModal = (chatId, chatData) => {
            currentChatId = chatId;
            document.getElementById('chat-modal-title').textContent = `Chat about Order #${chatData.displayOrderId}`;
            const chatContainer = document.getElementById('chat-container');
            
            const messagesRef = ref(db, `chats/${chatId}/messages`);
            activeChatListener = onValue(messagesRef, (snapshot) => {
                 chatContainer.innerHTML = '';
                 if(snapshot.exists()){
                     snapshot.forEach(msgSnapshot => {
                         const msg = msgSnapshot.val();
                         const msgDiv = document.createElement('div');
                         msgDiv.classList.add('chat-message', msg.sender === 'user' ? 'user-message' : 'admin-message');
                         msgDiv.textContent = msg.text;
                         chatContainer.appendChild(msgDiv);
                     });
                 }
                 chatContainer.scrollTop = chatContainer.scrollHeight;
            });

            chatModal.classList.add('active');
            update(ref(db, `chats/${chatId}`), { isReadByAdmin: true });
        };
        
        document.getElementById('send-reply-btn').addEventListener('click', () => {
            const replyInput = document.getElementById('chat-reply-input');
            const replyText = replyInput.value.trim();
            if (replyText && currentChatId) {
                const messagesRef = ref(db, `chats/${currentChatId}/messages`);
                const newMessage = { sender: 'admin', text: replyText, timestamp: Date.now() };
                push(messagesRef, newMessage);
                update(ref(db, `chats/${currentChatId}`), { lastUpdated: Date.now(), isReadByAdmin: true });
                replyInput.value = '';
            }
        });
        
        document.querySelectorAll('.modal').forEach(modal => { 
            modal.addEventListener('click', e => { 
                if (e.target === modal || e.target.classList.contains('close-btn')) { 
                    modal.classList.remove('active'); 
                    if(modal.id === 'chat-modal' && activeChatListener) {
                        activeChatListener(); // Detach the listener when closing the chat modal
                        activeChatListener = null;
                    }
                } 
            }); 
        });
    </script>
    <!-- Tumhara pura admin panel ka HTML upar hoga -->

<script type="module">
  // ðŸ”’ ADMIN EMAIL LOCK
  const ADMIN_EMAIL = "iwantstrength74@gmail.com";

  import { getAuth, onAuthStateChanged, signOut } 
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const auth = getAuth();

  onAuthStateChanged(auth, async (user) => {

    if (!user) {
      alert("Admin login required");
      window.location.href = "index.html";
      return;
    }

    if (user.email !== ADMIN_EMAIL) {
      alert("Access Denied");

      await signOut(auth);   // force logout
      window.location.href = "index.html";
      return;
    }

    console.log("Admin Verified");
  });
</script>
</body>
</html>
