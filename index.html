<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop now</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root { 
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545; 
            --bg-color: #f9f9f9; --text-color: #212529; --card-bg: #fff; --card-border: #eee;
            --font-family: 'Poppins', sans-serif; --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); --border-radius: 8px; 
            --star-color: #ffc107;
        }
        body.dark-mode {
            --bg-color: #121212; --text-color: #f1f1f1; --card-bg: #1e1e1e; --card-border: #444;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); padding-top: 60px; padding-bottom: 60px; transition: background-color 0.3s, color 0.3s; }
        .page { display: none; }
        .page.active { display: block; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 90%; max-width: 500px; position: relative; max-height: 90vh; overflow-y: auto;}
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; color: var(--secondary-color); }
        button, .btn { padding: 10px 15px; border: none; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; font-family: var(--font-family); font-size: 1rem; transition: background-color 0.3s; }
        button:hover, .btn:hover { background-color: #0056b3; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        input, textarea { width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: var(--font-family); background-color: var(--card-bg); color: var(--text-color); }
        .header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--card-bg); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: var(--box-shadow); z-index: 999; }
        .header .logo { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); opacity: 0; transition: opacity 0.3s ease-in-out; min-height: 29px; }
        .header .header-icons { display: flex; align-items: center; gap: 15px; }
        .header .search-icon { font-size: 1.2rem; cursor: pointer; }
        #login-status-indicator { width: 10px; height: 10px; background-color: var(--success-color); border-radius: 50%; display: none; }
        #login-status-indicator.active { display: block; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--card-bg); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 999; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-color); text-decoration: none; position: relative; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 1.5rem; }
        .nav-item span { font-size: 0.7rem; }
        .badge { position: absolute; top: -5px; right: -10px; background-color: var(--danger-color); color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem; display: none; }
        .badge.active { display: block; }
        #home .slider-container { width: 100%; height: 200px; position: relative; overflow: hidden; background: #eee; margin-bottom: 20px; border-radius: var(--border-radius); }
        #home .slider { display: flex; height: 100%; transition: transform 0.5s ease-in-out; }
        #home .slide { min-width: 100%; height: 100%; display: block; }
        #home .slide img { width: 100%; height: 100%; object-fit: cover; }
        #home .slider-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; cursor: pointer; z-index: 10; border-radius: 50%; width: 40px; height: 40px; display:flex; align-items:center; justify-content:center;}
        #home .prev-slide { left: 10px; }
        #home .next-slide { right: 10px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 15px; }
        .product-card { border: 1px solid var(--card-border); border-radius: var(--border-radius); overflow: hidden; text-align: center; box-shadow: var(--box-shadow); display: flex; flex-direction: column; justify-content: space-between; background-color: var(--card-bg); position: relative; }
        .product-card-clickable { cursor: pointer; flex-grow: 1; }
        .product-card img { width: 100%; height: 150px; object-fit: contain; background-color: #fdfdfd; }
        .product-card.out-of-stock img { opacity: 0.6; }
        .product-info { padding: 10px; }
        .product-info h3 { font-size: 1rem; margin-bottom: 5px; }
        .price { font-weight: 600; color: var(--primary-color); }
        .price .original-price { text-decoration: line-through; color: var(--secondary-color); font-weight: 400; font-size: 0.9em; margin-left: 8px; }
        .discount-badge { position: absolute; top: 8px; left: 8px; background-color: var(--danger-color); color: white; padding: 3px 8px; font-size: 0.75rem; font-weight: 500; border-radius: 4px; z-index: 1; }
        .product-actions { display: flex; flex-direction: column; gap: 8px; padding: 10px; border-top: 1px solid var(--card-border); }
        .out-of-stock-label { padding: 10px; background-color: var(--danger-color); color: white; font-weight: 600; font-size: 0.9rem; text-align: center; border-top: 1px solid var(--card-border);}
        .btn-small { padding: 8px 10px; font-size: 0.8rem; }
        .buy-now-btn { background-color: var(--success-color); }
        .buy-now-btn:hover { background-color: #218838; }
        .cart-item, .address-card, .coupon-card { background-color: var(--card-bg); border: 1px solid var(--card-border); }
        .cart-item { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; border-radius: var(--border-radius); }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: var(--border-radius); margin-right: 15px; }
        .item-details { flex-grow: 1; }
        .page-content { padding: 15px; }
        .page-content h1 { margin-bottom: 20px; }
        .order-tracking-card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: var(--box-shadow); overflow: hidden; }
        .tracking-header { display: flex; align-items: center; padding: 15px; gap: 15px; border-bottom: 1px solid var(--card-border); }
        .tracking-header .info h3 { font-size: 1.1rem; font-weight: 600; margin: 0; }
        .tracking-header .info p { font-size: 0.9rem; color: #666; margin: 4px 0 0; }
        .order-items-summary { padding: 15px; background-color: var(--bg-color); border-bottom: 1px solid var(--card-border); }
        .order-items-summary h4 { margin: 0 0 10px 0; font-size: 1rem; font-weight: 600; }
        .order-summary-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer; }
        .order-summary-item img { width: 50px; height: 50px; border-radius: var(--border-radius); object-fit: cover; }
        .order-summary-item .details { flex-grow: 1; display: flex; justify-content: space-between; }
        .order-summary-total { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--card-border); display: flex; justify-content: space-between; }
        .tracking-timeline-container { padding: 30px 20px; }
        .tracking-timeline { display: flex; justify-content: space-between; position: relative; align-items: center; }
        .tracker-line { position: absolute; top: 8px; left: 12.5%; width: 75%; height: 4px; background-color: #e0e0e0; z-index: 1; }
        .tracker-progress { position: absolute; top: 8px; left: 12.5%; height: 4px; background-color: var(--success-color); z-index: 2; transition: width 0.5s ease; }
        .tracker-truck { position: absolute; top: -5px; font-size: 1.5rem; color: #007bff; z-index: 3; transition: left 0.5s ease; transform: translateX(-50%); }
        .tracking-step { display: flex; flex-direction: column; align-items: center; z-index: 3; width: 25%; text-align: center; position: relative; }
        .tracking-step .icon { width: 20px; height: 20px; border-radius: 50%; background-color: #e0e0e0; border: 2px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8rem; }
        .tracking-step.completed .icon { background-color: var(--success-color); border-color: var(--success-color); }
        .tracking-step .label { margin-top: 10px; font-size: 0.75rem; }
        .tracking-step .date { font-size: 0.7rem; color: #888; min-height: 1.2em; }
        #menu-modal { align-items: flex-start; justify-content: flex-start; }
        #menu-modal .modal-content { width: 100%; height: 100%; border-radius: 0; box-shadow: none; }
        .menu-list { list-style: none; padding-top: 40px; }
        .menu-list li a { display: block; padding: 15px 0; text-decoration: none; color: var(--text-color); font-size: 1.2rem; border-bottom: 1px solid var(--card-border); }
        .address-card { padding: 15px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); margin-bottom: 15px; }
        .address-card p { margin: 0 0 5px 0; line-height: 1.4; }
        .address-card .actions { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .address-card .actions button { margin-right: 10px; }
        .address-option { display: flex; padding: 15px; border: 1px solid #ddd; border-radius: var(--border-radius); margin-bottom: 10px; cursor: pointer; }
        .address-option input[type="radio"] { margin-right: 15px; width: auto; }
        .address-option div p { margin: 0 0 5px 0; }
        .category-filters { display: flex; gap: 10px; padding: 10px 0; overflow-x: auto; -ms-overflow-style: none; scrollbar-width: none; }
        .category-filters::-webkit-scrollbar { display: none; }
        .category-btn { padding: 8px 20px; border: 1px solid var(--primary-color); border-radius: 20px; background-color: #e6f2ff; color: var(--primary-color); cursor: pointer; font-size: 0.9rem; font-weight: 500; white-space: nowrap; transition: background-color 0.3s, color 0.3s; }
        .category-btn.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        #product-detail-content { padding: 15px; background-color: var(--card-bg); }
        #pdp-main-image-container { width: 100%; height: 300px; margin-bottom: 15px; border-radius: var(--border-radius); overflow: hidden; background-color: #fdfdfd; position: relative;}
        #pdp-main-image { width: 100%; height: 100%; object-fit: contain; }
        #pdp-thumb-container { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .pdp-thumb-img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; }
        .pdp-thumb-img.active { border-color: var(--primary-color); }
        #pdp-name { font-size: 1.8rem; font-weight: 600; margin-bottom: 10px; }
        .pdp-discount-tag { display: inline-block; margin-left: 15px; padding: 5px 12px; background-color: var(--danger-color); color: white; font-size: 1rem; font-weight: 600; border-radius: 20px; vertical-align: middle; }
        #pdp-price { font-size: 1.5rem; font-weight: 700; margin-bottom: 15px; }
        #pdp-availability { font-size: 1rem; font-weight: 500; color: var(--success-color); margin-bottom: 15px; }
        #pdp-description { color: #666; line-height: 1.6; margin-bottom: 20px; }
        #pdp-actions { display: flex; gap: 10px; }
        #pdp-actions .btn { flex-grow: 1; }
        .back-btn { font-size: 1.5rem; color: var(--secondary-color); padding: 10px; position: absolute; top: 70px; left: 10px; background: rgba(255,255,255,0.8); border-radius: 50%; z-index: 10; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .coupon-section { display: flex; gap: 10px; margin-top: 15px; }
        .coupon-section input { margin: 0; }
        .coupon-section button { width: auto; }
        .cart-summary-row { display: flex; justify-content: space-between; margin-top: 8px; }
        .coupon-card { border: 2px dashed var(--primary-color); border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .coupon-info h3 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .coupon-info p { margin: 0 0 10px 0; color: #666; }
        .coupon-info code { background: #eee; padding: 3px 6px; border-radius: 4px; color: #333;}
        .btn-copy { background-color: var(--success-color); font-size: 0.9rem; }
        .theme-switcher { display: flex; align-items: center; gap: 8px; }
        .theme-switcher i { font-size: 1.1rem; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }
        #app-promo-image { max-width: 100%; border-radius: var(--border-radius); cursor: pointer; }
        #chat-modal .chat-container { height: 70vh; max-height: 400px; overflow-y: auto; border: 1px solid var(--card-border); padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; }
        #chat-modal .chat-message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; line-height: 1.4; }
        #chat-modal .user-message { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 3px; }
        #chat-modal .admin-message { background-color: #e9ecef; color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 3px; }
        #chat-modal .chat-input { display: flex; }
        #chat-modal .chat-input input { flex-grow: 1; margin: 0; }
        #chat-modal .chat-input button { width: auto; margin-left: 10px; }
        #chat-order-details { font-size: 0.9em; color: var(--secondary-color); margin-bottom: 15px; border-bottom: 1px solid var(--card-border); padding-bottom: 10px; }
        .star-rating-input { display: flex; justify-content: center; font-size: 2rem; color: #ccc; margin-bottom: 15px; }
        .star-rating-input .star { cursor: pointer; transition: color 0.2s; }
        .star-rating-input .star:hover, .star-rating-input .star.selected { color: var(--star-color); }
        #pdp-reviews-summary { margin-top: 20px; margin-bottom: 15px;}
        .rating-bar-container { display: flex; align-items: center; margin-bottom: 5px; }
        .rating-bar-label { width: 50px; font-size: 0.9em; }
        .rating-bar { flex-grow: 1; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .rating-bar-fill { height: 100%; background-color: var(--star-color); width: 0%; transition: width 0.5s; }
        .review-card { border: 1px solid var(--card-border); border-radius: var(--border-radius); padding: 15px; margin-bottom: 15px; }
        .review-card .rating { color: var(--star-color); margin-bottom: 5px; }
        .review-card .user-info { font-weight: bold; margin-bottom: 10px; }
        .payment-method-btn, .online-payment-btn { width: 100%; margin-bottom: 10px; padding: 20px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; gap: 10px;}
        .payment-method-btn img, .online-payment-btn img { height: 24px; }
        #upi-qr-code { max-width: 200px; margin: 15px auto; display: block; border-radius: var(--border-radius); }
        .upi-id-wrapper { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        #upi-id-text { font-weight: bold; background: var(--bg-color); padding: 8px; border-radius: 4px; flex-grow: 1; }
        #copy-upi-id-btn { width: auto; flex-shrink: 0; }
        .review-item { display: flex; align-items: center; margin-bottom: 10px; gap: 10px; }
        .review-item img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px;}
        .review-item div { flex-grow: 1; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo"></div>
        <div class="header-icons">
             <div class="theme-switcher">
                <i class="fas fa-sun"></i>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
                <i class="fas fa-moon"></i>
            </div>
            <i class="fas fa-search search-icon"></i>
            <div id="login-status-indicator"></div>
        </div>
    </header>

    <main>
        <section id="home" class="page active">
            <div class="slider-container"><div class="slider"></div><button class="slider-nav prev-slide"><i class="fas fa-chevron-left"></i></button><button class="slider-nav next-slide"><i class="fas fa-chevron-right"></i></button></div>
            <div id="category-filters-container" style="padding: 0 15px;"></div>
            <div id="product-grid" class="product-grid"></div>
        </section>
        <section id="search" class="page"><div class="page-content"><input type="text" id="search-input" placeholder="Search for products..."><div id="search-results-grid" class="product-grid"></div></div></section>
        <section id="cart" class="page"><div class="page-content"><h1>Shopping Cart</h1><div id="cart-container"></div></div></section>
        <section id="profile" class="page"><div class="page-content"><h1>My Profile</h1><p>Email: <span id="user-profile-email"></span></p></div></section>
        <section id="orders" class="page"><div class="page-content"><h1>My Orders</h1><div id="orders-container"></div></div></section>
        <section id="address" class="page"><div class="page-content"><h1>My Addresses</h1><button id="add-new-address-btn" class="btn" style="width:100%; margin-bottom: 20px;">Add New Address</button><div id="address-container"></div></div></section>
        <section id="coupons" class="page"><div class="page-content"><h1>Available Coupons</h1><div id="coupons-list"></div></div></section>
        <section id="product-detail" class="page">
            <a href="#home" class="back-btn"><i class="fas fa-arrow-left"></i></a>
            <div id="product-detail-content">
                <div id="pdp-main-image-container"><img id="pdp-main-image" src="" alt="Product Image"></div>
                <div id="pdp-thumb-container"></div>
                <h1 id="pdp-name"></h1>
                <div id="pdp-price" class="price"></div>
                <div id="pdp-availability"></div>
                <div id="pdp-actions"></div>
                <hr style="margin: 20px 0;">
                <h2>Description</h2>
                <p id="pdp-description"></p>
                <hr style="margin: 20px 0;">
                <div id="pdp-reviews-container">
                    <h2>Customer Reviews</h2>
                    <div id="pdp-reviews-summary"></div>
                    <button id="see-all-reviews-btn" class="btn" style="width: 100%; display: none;">See All Reviews</button>
                </div>
                <hr style="margin: 20px 0;">
                <div id="more-products-container">
                    <h2>You Might Also Like</h2>
                    <div id="more-products-grid" class="product-grid"></div>
                </div>
            </div>
        </section>
    </main>

    <footer class="bottom-nav">
        <a href="#home" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#orders" class="nav-item"><i class="fas fa-box"></i><span>My Orders</span></a>
        <a href="#cart" class="nav-item"><i class="fas fa-shopping-cart"></i><span id="cart-badge" class="badge">0</span><span>Cart</span></a>
        <div id="menu-btn" class="nav-item"><i class="fas fa-bars"></i><span>Menu</span></div>
    </footer>

    <!-- Modals -->
    <div id="auth-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><div id="login-form-container" class="form-container active"><h2>Login</h2><form id="login-form"><input type="email" id="login-email" placeholder="Email" required><input type="password" id="login-password" placeholder="Password" required><button type="submit">Login</button></form><a class="toggle-link" id="show-register">No account? Register</a></div><div id="register-form-container" class="form-container"><h2>Register</h2><form id="register-form"><input type="email" id="register-email" placeholder="Email" required><input type="password" id="register-password" placeholder="Password (min. 6 characters)" required><button type="submit">Register</button></form><a class="toggle-link" id="show-login">Have an account? Login</a></div><div id="auth-error"></div></div></div>
    <div id="menu-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><ul class="menu-list" id="main-menu-list"></ul></div></div>
    <div id="address-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2 id="address-modal-title">Add New Address</h2><form id="address-form"><input type="hidden" id="address-id"><input type="text" id="address-name" placeholder="Full Name" required><input type="tel" id="address-phone" placeholder="Phone Number" required><textarea id="address-full" placeholder="House No., Building, Street" rows="3" required></textarea><input type="text" id="address-landmark" placeholder="Landmark / Town" required><input type="text" id="address-city" placeholder="City" required><input type="text" id="address-state" placeholder="State" required><input type="number" id="address-pincode" placeholder="Pincode" required><input type="text" id="address-country" placeholder="Country" required><button type="submit">Save Address</button></form></div></div>
    <div id="app-install-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Install Our App</h2><p>Click the image below to download!</p><a id="app-download-link" href="#" target="_blank" rel="noopener noreferrer"><img id="app-promo-image" src="" alt="Download App"></a></div></div>
    <div id="chat-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Chat with Admin</h2><div id="chat-order-details"></div><div class="chat-container" id="chat-container"></div><div class="chat-input"><input type="text" id="chat-message-input" placeholder="Type your message..."><button id="send-message-btn">Send</button></div></div></div>
    <div id="rating-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Rate Product</h2><form id="rating-form"><input type="hidden" id="rating-product-id"><div class="star-rating-input" id="rating-stars"> <span class="star" data-value="1">â˜…</span><span class="star" data-value="2">â˜…</span><span class="star" data-value="3">â˜…</span><span class="star" data-value="4">â˜…</span><span class="star" data-value="5">â˜…</span> </div><textarea id="rating-review" placeholder="Tell us what you liked about the product..." rows="4" required></textarea><button type="submit">Submit Review</button></form></div></div>
    <div id="all-reviews-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>All Reviews</h2><div id="all-reviews-list"></div></div></div>
    
    <!-- Checkout Flow Modals -->
    <div id="payment-method-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Select Payment Method</h2><button id="select-online-payment" class="payment-method-btn"><i class="fas fa-credit-card"></i> Online Payment</button><button id="select-cod" class="payment-method-btn">ðŸ’µ Cash on Delivery</button></div></div>
    <div id="online-payment-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Select App</h2><button class="online-payment-btn" data-app="PhonePe"><img src="https://i.ibb.co/r2nnG749/id-Ivol-SN8d-1758970789901.jpg" alt="PhonePe">PhonePe</button><button class="online-payment-btn" data-app="GooglePay"><img src="https://i.ibb.co/WN9cdgLs/Frame-43-1.png" alt="Google Pay">Google Pay</button><button class="online-payment-btn" data-app="Paytm"><img src="https://i.ibb.co/1GdGHghs/images-20.jpg" alt="Paytm">Paytm</button></div></div>
    <div id="upi-payment-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Scan & Pay</h2><img id="upi-qr-code" src="" alt="UPI QR Code"><div class="upi-id-wrapper"><span id="upi-id-text"></span><button id="copy-upi-id-btn" class="btn btn-small">Copy</button></div><input type="text" id="transaction-id-input" placeholder="Enter Transaction ID / UTR" required><button id="confirm-payment-btn" class="btn" style="width:100%;">Confirm Payment</button></div></div>
    <div id="order-review-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Review Your Order</h2><div id="review-items-container"></div><div id="review-summary-container"></div><button id="proceed-to-address-btn" class="btn" style="width:100%;">Proceed to Select Address</button></div></div>
    <div id="shipping-modal" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h2>Select Shipping Address</h2><div id="shipping-address-selection" class="address-selection"></div><button id="place-order-btn" class="btn" style="width:100%;">Place Order</button></div></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getDatabase, ref, get, set, onValue, remove, push, child, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBOhZz2vDFfYEN3PrZSHFcZmuJVW7ITm1g",
            authDomain: "tournament-25bd5.firebaseapp.com",
            databaseURL: "https://tournament-25bd5-default-rtdb.firebaseio.com",
            projectId: "tournament-25bd5",
            storageBucket: "tournament-25bd5.firebasestorage.app",
            messagingSenderId: "858103771410",
            appId: "1:858103771410:web:1727894382fa84649203cb",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let allProducts = [];
        let currentUser = null;
        let userCartRef = null;
        let userAddressesRef = null;
        let currentDiscount = { code: null, percentage: 0 };
        let appPromotionSettings = {};
        let upiSettings = {};
        let currentChatOrder = null;
        let currentRating = 0;
        let checkoutOrderData = {};

        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        const modals = document.querySelectorAll('.modal');
        
        const navigateTo = (hash) => {
            let targetId = hash ? hash.substring(1) : 'home';
            let productId = null;
            if (targetId.startsWith('product-detail=')) {
                productId = targetId.split('=')[1];
                targetId = 'product-detail';
            }
            if (targetId === 'cart') { currentDiscount = { code: null, percentage: 0 }; }
            const targetPage = document.getElementById(targetId);
            pages.forEach(p => p.classList.remove('active'));
            if (targetPage) {
                targetPage.classList.add('active');
                 if (targetId === 'product-detail' && productId) {
                    renderProductDetail(productId);
                    window.scrollTo(0, 0); 
                }
                if (targetId === 'coupons') { renderPublicCoupons(); }
            } else { document.getElementById('home').classList.add('active'); }
            const activeNav = targetId === 'product-detail' ? '#home' : `#${targetId}`;
            navItems.forEach(item => { const itemHash = item.getAttribute('href'); item.classList.toggle('active', itemHash === activeNav); });
        };

        window.addEventListener('hashchange', () => navigateTo(location.hash));
        document.addEventListener('DOMContentLoaded', () => { 
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark-mode', savedTheme === 'dark');
            document.getElementById('theme-toggle').checked = savedTheme === 'dark';
            navigateTo(location.hash || '#home'); 
            initApp(); 
        });
        
        document.querySelector('.search-icon').addEventListener('click', () => location.hash = 'search');
        navItems.forEach(item => { const href = item.getAttribute('href'); if (href) { item.addEventListener('click', (e) => { e.preventDefault(); location.hash = href; }); } });

        const authModal = document.getElementById('auth-modal');
        document.getElementById('show-register').addEventListener('click', () => { document.getElementById('login-form-container').classList.remove('active'); document.getElementById('register-form-container').classList.add('active'); document.getElementById('auth-error').textContent = ''; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('register-form-container').classList.remove('active'); document.getElementById('login-form-container').classList.add('active'); document.getElementById('auth-error').textContent = ''; });
        
        document.getElementById('login-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const email = document.getElementById('login-email').value; 
            const password = document.getElementById('login-password').value; 
            try { 
                await signInWithEmailAndPassword(auth, email, password); 
                closeModal(authModal); 
            } catch (error) { 
                document.getElementById('auth-error').textContent = error.message; 
            } 
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await set(ref(db, `users/${user.uid}`), {
                    email: user.email,
                    uid: user.uid,
                    createdAt: Date.now()
                });
                closeModal(authModal);
            } catch (error) {
                document.getElementById('auth-error').textContent = error.message;
            }
        });
        const logoutUser = () => { signOut(auth); closeModal(document.getElementById('menu-modal')); location.hash = '#home'; }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('login-status-indicator').classList.add('active');
                userCartRef = ref(db, `users/${user.uid}/cart`);
                userAddressesRef = ref(db, `users/${user.uid}/addresses`);
                attachFirebaseListeners();
                document.getElementById('user-profile-email').textContent = user.email;
            } else {
                document.getElementById('login-status-indicator').classList.remove('active');
                currentUser = null; userCartRef = null; userAddressesRef = null;
                updateCartUI({});
            }
            updateMenu();
        });
        
        const updateMenu = () => {
            const menuList = document.getElementById('main-menu-list');
            const commonItems = `<li><a href="#address" class="menu-link"><i class="fas fa-map-marker-alt"></i> My Addresses</a></li><li><a href="#coupons" class="menu-link"><i class="fas fa-gift"></i> My Coupons</a></li>`;
            
            let appInstallItem = '';
            if (appPromotionSettings.imageUrl && appPromotionSettings.downloadUrl) {
                appInstallItem = `<li><a href="#" id="install-app-link"><i class="fas fa-download"></i> Install Shop Now App</a></li>`;
            }

            let menuHTML = currentUser
                ? `<li><a href="#profile" class="menu-link"><i class="fas fa-user"></i> Profile</a></li>${commonItems}${appInstallItem}<li><a href="#" id="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a></li>`
                : `<li><a href="#" id="login-link"><i class="fas fa-sign-in-alt"></i> Login</a></li>${appInstallItem}`;

            menuList.innerHTML = menuHTML;

            if (currentUser) { document.getElementById('logout-link').addEventListener('click', logoutUser); } 
            else { 
                const loginLink = document.getElementById('login-link');
                if(loginLink) loginLink.addEventListener('click', () => { closeModal(document.getElementById('menu-modal')); openModal(authModal); }); 
            }
            
            if (appInstallItem) {
                document.getElementById('install-app-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    closeModal(document.getElementById('menu-modal'));
                    document.getElementById('app-promo-image').src = appPromotionSettings.imageUrl;
                    document.getElementById('app-download-link').href = appPromotionSettings.downloadUrl;
                    openModal(document.getElementById('app-install-modal'));
                });
            }

            document.querySelectorAll('.menu-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); location.hash = link.getAttribute('href'); closeModal(document.getElementById('menu-modal')); }); });
        };
        
        const renderProducts = (products, containerId) => {
            const grid = document.getElementById(containerId);
            if (!grid) return;
            if (!products || products.length === 0) { 
                if (containerId === 'search-results-grid' && document.getElementById('search-input').value) {
                    grid.innerHTML = '<p>No products found matching your search.</p>';
                } else if (containerId !== 'search-results-grid' && containerId !== 'more-products-grid') {
                    grid.innerHTML = '<p>No products found.</p>';
                } else {
                    grid.innerHTML = '';
                }
                return; 
            }
            grid.innerHTML = products.map(p => {
                const isOutOfStock = p.stockStatus === false;
                let priceHTML = `â‚¹${parseFloat(p.price).toFixed(2)}`;
                let badgeHTML = '';
                if (p.discountPercentage && p.discountPercentage > 0) {
                    priceHTML += ` <span class="original-price">â‚¹${parseFloat(p.originalPrice).toFixed(2)}</span>`;
                    badgeHTML = `<div class="discount-badge">${p.discountPercentage}% OFF</div>`;
                }

                return `
                <div class="product-card ${isOutOfStock ? 'out-of-stock' : ''}" data-product-id="${p.id}">
                    ${badgeHTML}
                    <div class="product-card-clickable">
                        <img src="${p.imageUrl}" alt="${p.name}">
                        <div class="product-info">
                            <h3>${p.name}</h3>
                            <p class="price">${priceHTML}</p>
                        </div>
                    </div>
                    ${isOutOfStock 
                        ? `<div class="out-of-stock-label">Out of Stock</div>` 
                        : `<div class="product-actions">
                               <button class="add-to-cart-btn btn-small" data-product-id="${p.id}">Add to Cart</button>
                               <button class="buy-now-btn btn-small" data-product-id="${p.id}">Buy Now</button>
                           </div>`
                    }
                </div>`;
            }).join('');
        };
        
        const renderCategoriesAndProducts = (products) => {
            const allCats = products.map(p => p.category && p.category.trim()).filter(Boolean);
            const uniqueCats = [...new Set(allCats)];
            const categories = ['All', ...uniqueCats];
            
            const container = document.getElementById('category-filters-container');
            if (categories.length > 1) {
                container.innerHTML = `<div class="category-filters">${categories.map(cat => `<button class="category-btn ${cat === 'All' ? 'active' : ''}" data-category="${cat}">${cat}</button>`).join('')}</div>`;
                const filterBtns = container.querySelectorAll('.category-btn');
                filterBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        filterBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const selectedCategory = btn.dataset.category;
                        const filteredProducts = selectedCategory === 'All' 
                            ? allProducts 
                            : allProducts.filter(p => p.category && p.category.trim() === selectedCategory);
                        renderProducts(filteredProducts, 'product-grid');
                    });
                });
            } else { 
                container.innerHTML = ''; 
            }
            renderProducts(products, 'product-grid');
        };

        const updateCartUI = (cart) => {
            const cartContainer = document.getElementById('cart-container');
            const cartBadge = document.getElementById('cart-badge');
            if (!cart || Object.keys(cart).length === 0) { cartContainer.innerHTML = '<p>Your cart is empty.</p>'; cartBadge.textContent = '0'; cartBadge.classList.remove('active'); return; }
            let totalItems = 0, subTotal = 0;
            let cartHTML = Object.entries(cart).map(([productId, item]) => {
                const product = allProducts.find(p => p.id === productId);
                if (!product) return '';
                subTotal += product.price * item.quantity;
                totalItems += item.quantity;
                return `<div class="cart-item" data-product-id="${productId}"><img src="${product.imageUrl}" alt="${product.name}"><div class="item-details"><h3>${product.name}</h3><p>â‚¹${(product.price * item.quantity).toFixed(2)}</p></div><div class="item-actions"><div class="quantity-controls"><button class="quantity-decrease">-</button><span>${item.quantity}</span><button class="quantity-increase">+</button></div></div></div>`;
            }).join('');
            
            let discountAmount = 0;
            if(currentDiscount.percentage > 0){
                discountAmount = subTotal * (currentDiscount.percentage / 100);
            }
            const grandTotal = subTotal - discountAmount;

            const summaryHTML = `
                <div class="cart-summary" style="padding:15px; background-color:var(--card-bg); border:1px solid var(--card-border); border-radius:8px; margin-top: 15px;">
                    <div class="cart-summary-row"><span>Subtotal:</span> <span>â‚¹${subTotal.toFixed(2)}</span></div>
                    <div class="coupon-section">
                        <input type="text" id="coupon-input" placeholder="Enter coupon code">
                        <button id="apply-coupon-btn" class="btn btn-small">Apply</button>
                    </div>
                    <div id="coupon-feedback"></div>
                    ${currentDiscount.percentage > 0 ? `
                    <div class="cart-summary-row" style="color:var(--success-color);">
                        <span>Discount (${currentDiscount.code}):</span> 
                        <span>-â‚¹${discountAmount.toFixed(2)}</span>
                    </div>` : ''}
                    <hr style="margin: 10px 0;">
                    <div class="cart-summary-row" style="font-weight:bold; font-size: 1.2em;">
                        <span>Grand Total:</span> 
                        <span>â‚¹${grandTotal.toFixed(2)}</span>
                    </div>
                </div>`;
            
            cartContainer.innerHTML = cartHTML + summaryHTML + `<button class="checkout-btn btn" style="width:100%; margin-top: 15px;">Proceed to Checkout</button>`;
            cartBadge.textContent = totalItems; cartBadge.classList.add('active');
            
            document.getElementById('apply-coupon-btn').addEventListener('click', applyCoupon);
        };
        
        const applyCoupon = async () => {
            const codeInput = document.getElementById('coupon-input');
            const feedbackDiv = document.getElementById('coupon-feedback');
            const code = codeInput.value.toUpperCase().trim();
            if (!code) { feedbackDiv.innerHTML = `<p style="color:red;">Please enter a code.</p>`; return; }
            const snapshot = await get(ref(db, `coupons/${code}`));
            if(snapshot.exists()){
                const data = snapshot.val();
                currentDiscount = { code: code, percentage: data.percentage };
                feedbackDiv.innerHTML = `<p style="color:green;">Coupon "${code}" applied! ${data.percentage}% OFF.</p>`;
            } else {
                currentDiscount = { code: null, percentage: 0 };
                feedbackDiv.innerHTML = `<p style="color:red;">Invalid coupon code.</p>`;
            }
            const cartSnapshot = await get(userCartRef);
            updateCartUI(cartSnapshot.val() || {});
        };
        
        const fetchOrders = () => {
            if (!currentUser) return;
            const ordersRef = ref(db, `orders/${currentUser.uid}`);
            onValue(ordersRef, (snapshot) => {
                const ordersData = snapshot.val();
                const container = document.getElementById('orders-container');
                if (ordersData) {
                    container.innerHTML = Object.values(ordersData).sort((a, b) => b.date - a.date).map(order => {
                        let deliveryInfo = 'Delivery date will be updated soon.';
                        let statusDisplay = '';
                        let messageButton = '';
                        let rateButton = '';
                        let paymentStatusInfo = '';

                        if(order.status === 'Waiting for Payment Confirmation') {
                           paymentStatusInfo = `<p style="color: #ffc107; font-weight: bold;">Waiting for payment confirmation</p>`;
                        } else if (order.paymentMethod === 'UPI') {
                           paymentStatusInfo = `<p style="color: var(--success-color);">Payment successful</p>`;
                        }

                        if (order.status === 'Cancelled') {
                            deliveryInfo = 'This order has been cancelled.';
                            statusDisplay = `<div style="color: var(--danger-color); font-weight: 600; border: 2px solid var(--danger-color); padding: 5px 10px; border-radius: 8px; margin-left: auto; text-align: center;"><i class="fas fa-times-circle" style="margin-right: 5px;"></i>Cancelled</div>`;
                        } else if (order.status === 'Delivered') {
                            deliveryInfo = `Delivered on ${new Date(order.deliveredDate).toDateString()}`;
                             rateButton = Object.keys(order.items).map(productId =>
                                `<button class="btn btn-small rate-product-btn" data-product-id="${productId}" style="margin-top: 10px;">Rate Product</button>`
                            ).join('');
                        } else if (order.estimatedDeliveryDate) {
                            deliveryInfo = `Delivery by ${new Date(order.estimatedDeliveryDate.replace(/-/g, '/')).toDateString()}`;
                        }
                         messageButton = `<button class="btn btn-small message-admin-btn" data-order-id="${order.orderId}" data-display-order-id="${order.displayOrderId}" style="margin-top: 10px; background-color: var(--secondary-color);">Message Admin</button>`;


                        const itemsHTML = Object.entries(order.items).map(([productId, item]) => {
                            const orderedProduct = allProducts.find(p => p.id === productId);
                            const imageUrl = orderedProduct ? orderedProduct.imageUrl : 'https://via.placeholder.com/50';
                            return `<div class="order-summary-item" data-product-id="${productId}"><img src="${imageUrl}" alt="${item.name}"><div class="details"><span>${item.name} (x${item.quantity})</span><span>â‚¹${(item.price * item.quantity).toFixed(2)}</span></div></div>`;
                        }).join('');

                        let trackingHTML = '';
                        if (order.status !== 'Cancelled' && order.status !== 'Waiting for Payment Confirmation') {
                            const steps = [ { name: 'Ordered', status: 'Pending', date: order.date }, { name: 'Shipped', status: 'Shipped', date: order.shippedDate }, { name: 'Out for Delivery', status: 'Out for Delivery', date: order.outForDeliveryDate }, { name: 'Delivered', status: 'Delivered', date: order.deliveredDate } ];
                            const currentStepIndex = steps.findIndex(step => step.status === order.status);
                            const progress = currentStepIndex >= 0 ? (currentStepIndex / (steps.length - 1)) * 100 : 0;
                            const stepsHTML = steps.map((step, index) => `<div class="tracking-step ${index <= currentStepIndex ? 'completed' : ''}"><div class="icon">${index <= currentStepIndex ? '<i class="fas fa-check"></i>' : ''}</div><div class="label">${step.name}</div><div class="date">${step.date ? new Date(step.date).toLocaleDateString('en-GB', {day:'2-digit', month:'short'}) : ''}</div></div>`).join('');
                            trackingHTML = `<div class="tracking-timeline-container"><div class="tracking-timeline"><div class="tracker-line"></div><div class="tracker-progress" style="width: ${progress}%;"></div>${order.status !== 'Delivered' ? `<div class="tracker-truck" style="left: ${progress}%;"><i class="fas fa-truck"></i></div>` : ''}${stepsHTML}</div></div>`;
                        }
                        
                        return `<div class="order-tracking-card"><div class="tracking-header"><div class="info"><h3>Order #${order.displayOrderId}</h3>${paymentStatusInfo}<p>${deliveryInfo}</p></div>${statusDisplay}</div><div class="order-items-summary"><h4>Items in this order:</h4>${itemsHTML}${order.discountApplied && order.discountApplied.percentage > 0 ? `<div class="order-summary-item" style="color: var(--success-color);"><span>Discount (${order.discountApplied.code}):</span><span>-â‚¹${(order.subTotal - order.totalAmount).toFixed(2)}</span></div>` : ''}<div class="order-summary-total"><strong>Total Paid:</strong><strong>â‚¹${order.totalAmount.toFixed(2)}</strong></div><div class="order-actions" style="display:flex; gap: 10px;">${messageButton}${rateButton}</div></div>${trackingHTML}</div>`;

                    }).join('');
                } else { container.innerHTML = '<p>You have no orders yet.</p>'; }
            });
        };
        
        const renderProductDetail = (productId) => {
            const product = allProducts.find(p => p.id === productId);
            if (!product) { location.hash = '#home'; return; }
            
            document.getElementById('pdp-main-image').src = product.imageUrl;
            
            let priceHTML = `â‚¹${parseFloat(product.price).toFixed(2)}`;
            const nameElement = document.getElementById('pdp-name');
            nameElement.innerHTML = product.name;

            if (product.discountPercentage && product.discountPercentage > 0) {
                priceHTML += ` <span class="original-price">â‚¹${parseFloat(product.originalPrice).toFixed(2)}</span>`;
                nameElement.innerHTML += `<span class="pdp-discount-tag">${product.discountPercentage}% OFF</span>`;
            }
            
            document.getElementById('pdp-price').innerHTML = priceHTML;

            const availabilityElement = document.getElementById('pdp-availability');
            if (product.stockStatus !== false && product.availabilityText) {
                availabilityElement.textContent = product.availabilityText;
                availabilityElement.style.color = 'var(--success-color)';
            } else {
                availabilityElement.textContent = '';
            }

            document.getElementById('pdp-description').textContent = product.description || 'No description available.';
            const images = [product.imageUrl, product.imageUrl2, product.imageUrl3, product.imageUrl4, product.imageUrl5].filter(Boolean);
            const thumbContainer = document.getElementById('pdp-thumb-container');
            thumbContainer.innerHTML = images.map((imgUrl, index) => `<img src="${imgUrl}" class="pdp-thumb-img ${index === 0 ? 'active' : ''}" alt="Thumbnail">`).join('');
            thumbContainer.querySelectorAll('.pdp-thumb-img').forEach(thumb => { thumb.addEventListener('click', () => { document.getElementById('pdp-main-image').src = thumb.src; thumbContainer.querySelectorAll('.pdp-thumb-img').forEach(t => t.classList.remove('active')); thumb.classList.add('active'); }); });
            
            const actionsContainer = document.getElementById('pdp-actions');
            if (product.stockStatus === false) {
                 actionsContainer.innerHTML = `<div class="out-of-stock-label" style="width:100%; text-align:center; padding: 12px; font-size: 1rem;">Out of Stock</div>`;
                 availabilityElement.textContent = '';
            } else {
                actionsContainer.innerHTML = `<button class="add-to-cart-btn btn" data-product-id="${product.id}">Add to Cart</button><button class="buy-now-btn btn" data-product-id="${product.id}">Buy Now</button>`;
            }
            
            renderProductReviewsSummary(productId);

            const relatedProducts = allProducts.filter(p => p.category === product.category && p.id !== product.id).slice(0, 4);
            renderProducts(relatedProducts, 'more-products-grid');
        };
        
        const renderProductReviewsSummary = (productId) => {
            const summaryContainer = document.getElementById('pdp-reviews-summary');
            const seeAllBtn = document.getElementById('see-all-reviews-btn');
            onValue(ref(db, `ratings/${productId}`), (snapshot) => {
                summaryContainer.innerHTML = '';
                seeAllBtn.style.display = 'none';
                if (snapshot.exists()) {
                    const ratings = Object.values(snapshot.val()).filter(r => r.active);
                    if (ratings.length > 0) {
                        seeAllBtn.style.display = 'block';
                        seeAllBtn.onclick = () => showAllReviewsModal(productId);

                        const totalRatings = ratings.length;
                        const ratingCounts = [0, 0, 0, 0, 0];
                        ratings.forEach(r => ratingCounts[r.rating - 1]++);

                        let summaryHTML = '';
                        for (let i = 5; i >= 1; i--) {
                            const percentage = totalRatings > 0 ? (ratingCounts[i - 1] / totalRatings) * 100 : 0;
                            summaryHTML += `
                                <div class="rating-bar-container">
                                    <div class="rating-bar-label">${i} star</div>
                                    <div class="rating-bar"><div class="rating-bar-fill" style="width: ${percentage}%;"></div></div>
                                </div>`;
                        }
                        summaryContainer.innerHTML = summaryHTML;
                    } else {
                        summaryContainer.innerHTML = '<p>No reviews for this product yet.</p>';
                    }
                } else {
                     summaryContainer.innerHTML = '<p>No reviews for this product yet.</p>';
                }
            });
        };

        const showAllReviewsModal = (productId) => {
            const listContainer = document.getElementById('all-reviews-list');
            listContainer.innerHTML = '<p>Loading reviews...</p>';
            onValue(ref(db, `ratings/${productId}`), (snapshot) => {
                if(snapshot.exists()) {
                    const ratings = Object.values(snapshot.val()).filter(r => r.active);
                     if (ratings.length > 0) {
                        listContainer.innerHTML = ratings.map(review => `
                            <div class="review-card">
                                <div class="rating">${'â˜…'.repeat(review.rating)}${'â˜†'.repeat(5 - review.rating)}</div>
                                <div class="user-info">${review.userEmail.split('@')[0]}</div>
                                <p>${review.review}</p>
                            </div>`
                        ).join('');
                     } else {
                        listContainer.innerHTML = '<p>No reviews for this product yet.</p>';
                     }
                } else {
                    listContainer.innerHTML = '<p>No reviews for this product yet.</p>';
                }
            }, { onlyOnce: true });
            openModal(document.getElementById('all-reviews-modal'));
        };


        const renderPublicCoupons = () => {
            const container = document.getElementById('coupons-list');
            onValue(ref(db, 'publicCoupons'), (snapshot) => {
                container.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(child => {
                        const data = child.val();
                        if (data.isActive) {
                            container.innerHTML += `<div class="coupon-card"><div class="coupon-info"><h3>${data.discount}% OFF</h3><p>${data.description}</p><code>${data.code}</code></div><button class="btn-copy" data-code="${data.code}">Copy Code</button></div>`;
                        }
                    });
                } 
                if (container.innerHTML === '') {
                    container.innerHTML = '<p>No coupons are available right now.</p>';
                }
            });
        };

        const initApp = () => {
            const logoEl = document.querySelector('.header .logo');
            onValue(ref(db, 'settings/shopName'), (snapshot) => { const shopName = snapshot.exists() ? snapshot.val() : 'Shop'; logoEl.textContent = shopName; document.title = shopName; logoEl.style.opacity = '1'; });
            onValue(ref(db, 'settings/appPromotion'), (snapshot) => { 
                if (snapshot.exists()) { appPromotionSettings = snapshot.val(); } 
                else { appPromotionSettings = {}; }
                updateMenu();
            });
             onValue(ref(db, 'settings/upiDetails'), (snapshot) => { 
                if (snapshot.exists()) { upiSettings = snapshot.val(); } 
                else { upiSettings = {}; }
            });
            onValue(ref(db, 'products'), (snapshot) => { allProducts = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, data]) => ({ id, ...data })) : []; renderCategoriesAndProducts(allProducts); fetchOrders(); });
            onValue(ref(db, 'sliderImages'), (snapshot) => { renderSlider(snapshot.exists() ? Object.values(snapshot.val()) : []); });
        };

        const renderSlider = (sliderImages) => {
            const sliderContainer = document.querySelector('#home .slider-container');
            if (!sliderContainer) return;
            const slider = sliderContainer.querySelector('.slider');
            if (sliderImages && sliderImages.length > 0) {
                slider.innerHTML = sliderImages.map(img => {
                    const imgTag = `<img src="${img.downloadURL}" alt="Slider Image">`;
                    if (img.productId) {
                        return `<a href="#product-detail=${img.productId}" class="slide">${imgTag}</a>`;
                    } else {
                        return `<div class="slide">${imgTag}</div>`;
                    }
                }).join('');
                initSlider();
            } else {
                slider.innerHTML = `<div class="slide" style="background: #ccc; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#888;">No Banners</div>`;
            }
        };
        let currentSlide = 0; let slideInterval;
        const initSlider = () => { const slides = document.querySelectorAll('#home .slide'); if (slides.length <= 1) return; const slider = document.querySelector('#home .slider'); const nextBtn = document.querySelector('#home .next-slide'); const prevBtn = document.querySelector('#home .prev-slide'); const goToSlide = (i) => { slider.style.transform = `translateX(-${i * 100}%)`; currentSlide = i; }; const next = () => goToSlide((currentSlide + 1) % slides.length); const prev = () => goToSlide((currentSlide - 1 + slides.length) % slides.length); const resetInterval = () => { clearInterval(slideInterval); slideInterval = setInterval(next, 3000); }; nextBtn.addEventListener('click', () => { next(); resetInterval(); }); prevBtn.addEventListener('click', () => { prev(); resetInterval(); }); resetInterval(); };
        const attachFirebaseListeners = () => { 
            if (userCartRef) onValue(userCartRef, (snapshot) => updateCartUI(snapshot.val() || {})); 
            if (userAddressesRef) onValue(userAddressesRef, (snapshot) => renderAddresses(snapshot.val() || {})); 
            fetchOrders(); 
        };
        const handleAddToCart = async (productId) => { if (!currentUser) { openModal(authModal); return; } const productRef = ref(db, `users/${currentUser.uid}/cart/${productId}`); const snapshot = await get(productRef); let currentQuantity = snapshot.exists() ? snapshot.val().quantity : 0; await set(productRef, { quantity: currentQuantity + 1 }); };
        const updateCartQuantity = async (productId, change) => { if (!currentUser) return; const productRef = ref(db, `users/${currentUser.uid}/cart/${productId}`); const snapshot = await get(productRef); if (!snapshot.exists()) return; let newQuantity = snapshot.val().quantity + change; if (newQuantity <= 0) { remove(productRef); } else { set(productRef, { quantity: newQuantity }); } };
        
        const openAddressModal = async (addressId = null) => { const addressForm = document.getElementById('address-form'); addressForm.reset(); document.getElementById('address-id').value = ''; if (addressId) { document.getElementById('address-modal-title').textContent = 'Edit Address'; const data = (await get(ref(db, `users/${currentUser.uid}/addresses/${addressId}`))).val(); if (data) { document.getElementById('address-id').value = addressId; document.getElementById('address-name').value = data.name || ''; document.getElementById('address-phone').value = data.phone || ''; document.getElementById('address-full').value = data.fullAddress || ''; document.getElementById('address-landmark').value = data.landmark || ''; document.getElementById('address-city').value = data.city || ''; document.getElementById('address-state').value = data.state || ''; document.getElementById('address-pincode').value = data.pincode || ''; document.getElementById('address-country').value = data.country || ''; } } else { document.getElementById('address-modal-title').textContent = 'Add New Address'; } openModal(document.getElementById('address-modal')); };
        document.getElementById('address-form').addEventListener('submit', async (e) => { e.preventDefault(); if (!currentUser) return; const addressId = document.getElementById('address-id').value; const addressData = { name: document.getElementById('address-name').value, phone: document.getElementById('address-phone').value, fullAddress: document.getElementById('address-full').value, landmark: document.getElementById('address-landmark').value, city: document.getElementById('address-city').value, state: document.getElementById('address-state').value, pincode: document.getElementById('address-pincode').value, country: document.getElementById('address-country').value, }; const addressRef = addressId ? ref(db, `users/${currentUser.uid}/addresses/${addressId}`) : push(userAddressesRef); await set(addressRef, addressData); closeModal(document.getElementById('address-modal')); });
        const handleDeleteAddress = async (addressId) => { if (!currentUser || !confirm("Delete this address?")) return; await remove(ref(db, `users/${currentUser.uid}/addresses/${addressId}`)); };
        const renderAddresses = (addresses) => { const container = document.getElementById('address-container'); if (addresses && Object.keys(addresses).length > 0) { container.innerHTML = Object.entries(addresses).map(([id, addr]) => `<div class="address-card"><p><b>${addr.name}</b></p><p>${addr.fullAddress || ''}</p><p>${addr.landmark || ''}</p><p>${addr.city || ''}, ${addr.state || ''} - ${addr.pincode || ''}</p><p>${addr.country || ''}</p><p>Phone: ${addr.phone || ''}</p><div class="actions"><button class="btn btn-secondary edit-address-btn" data-address-id="${id}">Edit</button><button class="btn btn-danger delete-address-btn" data-address-id="${id}">Delete</button></div></div>`).join(''); } else { container.innerHTML = '<p>You have no saved addresses.</p>'; } };

        // --- Checkout Flow Functions ---
        const startCheckout = async (items) => {
            if (!currentUser) { openModal(authModal); return; }
            if (!items || Object.keys(items).length === 0) { alert("No items to checkout."); return; }

            let subTotal = 0;
            const itemsObject = {};
            for (const productId in items) {
                const item = items[productId];
                const product = allProducts.find(p => p.id === productId);
                if(product){
                    subTotal += product.price * item.quantity;
                    itemsObject[productId] = { 
                        name: product.name, 
                        quantity: item.quantity, 
                        price: product.price,
                        imageUrl: product.imageUrl
                    };
                }
            }
            
            checkoutOrderData = { 
                items: itemsObject, 
                subTotal, 
                discountApplied: { code: null, percentage: 0 },
                totalAmount: subTotal
            };
            openModal(document.getElementById('payment-method-modal'));
        };
        
        document.getElementById('select-cod').addEventListener('click', () => {
            checkoutOrderData.paymentMethod = 'COD';
            checkoutOrderData.status = 'Pending';
            closeModal(document.getElementById('payment-method-modal'));
            showOrderReview();
        });

        document.getElementById('select-online-payment').addEventListener('click', () => {
            checkoutOrderData.paymentMethod = 'Online'; // UPDATED: Set temporary method
            closeModal(document.getElementById('payment-method-modal'));
            showOrderReview(); // UPDATED: Show review modal first
        });

        document.querySelectorAll('.online-payment-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('upi-qr-code').src = upiSettings.qrCodeUrl || '';
                document.getElementById('upi-id-text').textContent = upiSettings.upiId || 'Not available';
                closeModal(document.getElementById('online-payment-modal'));
                openModal(document.getElementById('upi-payment-modal'));
            });
        });

        document.getElementById('copy-upi-id-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(upiSettings.upiId || '').then(() => alert('UPI ID copied!'));
        });

        document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
            const transactionId = document.getElementById('transaction-id-input').value.trim();
            if (!transactionId) { alert('Please enter the transaction ID.'); return; }
            
            checkoutOrderData.paymentMethod = 'UPI';
            checkoutOrderData.status = 'Waiting for Payment Confirmation';
            checkoutOrderData.transactionId = transactionId;
            
            // UPDATED: Final order creation logic moved here for online payments
            if (!checkoutOrderData.shippingAddress) {
                alert('Error: Shipping address not selected. Please restart checkout.');
                return;
            }

            const newOrderRef = push(child(ref(db, 'orders'), currentUser.uid));
            const displayOrderId = Math.floor(100000 + Math.random() * 900000);

            const finalOrderData = {
                ...checkoutOrderData,
                orderId: newOrderRef.key,
                displayOrderId,
                date: Date.now(),
                userEmail: currentUser.email,
                isVisibleToAdmin: true
            };

            await set(newOrderRef, finalOrderData);
            if(userCartRef) await remove(userCartRef);

            closeModal(document.getElementById('upi-payment-modal'));
            alert('Order placed successfully! Your payment will be confirmed shortly.');
            location.hash = '#orders';
            checkoutOrderData = {};
        });

        const showOrderReview = () => {
            const itemsContainer = document.getElementById('review-items-container');
            const summaryContainer = document.getElementById('review-summary-container');
            
            itemsContainer.innerHTML = Object.values(checkoutOrderData.items).map(item => `
                <div class="review-item">
                    <img src="${item.imageUrl}" alt="${item.name}">
                    <div>
                        <span>${item.name} (x${item.quantity})</span><br>
                        <strong>â‚¹${(item.price * item.quantity).toFixed(2)}</strong>
                    </div>
                </div>
            `).join('');

            const discountAmount = checkoutOrderData.subTotal * (checkoutOrderData.discountApplied.percentage / 100);
            checkoutOrderData.totalAmount = checkoutOrderData.subTotal - discountAmount;

            summaryContainer.innerHTML = `
                <hr>
                <div class="coupon-section">
                    <input type="text" id="review-coupon-input" placeholder="Enter coupon code">
                    <button id="apply-review-coupon-btn" class="btn btn-small">Apply</button>
                </div>
                <div id="review-coupon-feedback"></div>
                <div class="cart-summary-row"><span>Subtotal:</span> <span>â‚¹${checkoutOrderData.subTotal.toFixed(2)}</span></div>
                ${checkoutOrderData.discountApplied.percentage > 0 ? `
                <div class="cart-summary-row" style="color:var(--success-color);">
                    <span>Discount (${checkoutOrderData.discountApplied.code}):</span> 
                    <span>-â‚¹${discountAmount.toFixed(2)}</span>
                </div>` : ''}
                <hr style="margin: 10px 0;">
                <div class="cart-summary-row" style="font-weight:bold; font-size: 1.2em;">
                    <span>Grand Total:</span> 
                    <span>â‚¹${checkoutOrderData.totalAmount.toFixed(2)}</span>
                </div>
            `;
            
            document.getElementById('apply-review-coupon-btn').addEventListener('click', applyCouponInReview);
            openModal(document.getElementById('order-review-modal'));
        };

        const applyCouponInReview = async () => {
            const codeInput = document.getElementById('review-coupon-input');
            const feedbackDiv = document.getElementById('review-coupon-feedback');
            const code = codeInput.value.toUpperCase().trim();
            if (!code) { feedbackDiv.innerHTML = `<p style="color:red;">Please enter a code.</p>`; return; }
            
            const snapshot = await get(ref(db, `coupons/${code}`));
            if(snapshot.exists()){
                const data = snapshot.val();
                checkoutOrderData.discountApplied = { code: code, percentage: data.percentage };
            } else {
                checkoutOrderData.discountApplied = { code: null, percentage: 0 };
                feedbackDiv.innerHTML = `<p style="color:red;">Invalid coupon code.</p>`;
            }
            showOrderReview(); // Re-render the modal with updated totals
        };

        document.getElementById('proceed-to-address-btn').addEventListener('click', async () => {
            closeModal(document.getElementById('order-review-modal'));
            const addresses = (await get(userAddressesRef)).val();
            const container = document.getElementById('shipping-address-selection');
            const placeOrderBtn = document.getElementById('place-order-btn');
            if (addresses && Object.keys(addresses).length > 0) {
                container.innerHTML = Object.entries(addresses).map(([id, addr], index) => `<label class="address-option"><input type="radio" name="shippingAddress" value="${id}" ${index === 0 ? 'checked' : ''}><div><p><b>${addr.name}</b></p><p>${addr.fullAddress || ''}, ${addr.landmark || ''}</p><p>${addr.city || ''}, ${addr.state || ''} - ${addr.pincode || ''}</p><p>${addr.country || ''}</p><p>Phone: ${addr.phone || ''}</p></div></label>`).join('');
                placeOrderBtn.style.display = 'block';
            } else {
                container.innerHTML = `<p>No saved addresses found. Please add an address first.</p>`;
                placeOrderBtn.style.display = 'none';
            }
            openModal(document.getElementById('shipping-modal'));
        });

        document.getElementById('place-order-btn').addEventListener('click', async () => {
            const selectedAddressRadio = document.querySelector('input[name="shippingAddress"]:checked');
            if (!selectedAddressRadio) { alert("Please select a shipping address."); return; }
            
            const addressSnapshot = await get(ref(db, `users/${currentUser.uid}/addresses/${selectedAddressRadio.value}`));
            checkoutOrderData.shippingAddress = addressSnapshot.val();

            // UPDATED: Conditional logic for COD vs Online
            if (checkoutOrderData.paymentMethod === 'COD') {
                const newOrderRef = push(child(ref(db, 'orders'), currentUser.uid));
                const displayOrderId = Math.floor(100000 + Math.random() * 900000);
                
                const finalOrderData = {
                    ...checkoutOrderData,
                    orderId: newOrderRef.key,
                    displayOrderId,
                    date: Date.now(),
                    userEmail: currentUser.email,
                    isVisibleToAdmin: true
                };
                
                await set(newOrderRef, finalOrderData);
                if(userCartRef) await remove(userCartRef); 
                
                closeModal(document.getElementById('shipping-modal'));
                alert('Order placed successfully!');
                location.hash = '#orders';
                checkoutOrderData = {}; 
            } else { // This handles 'Online' payment
                closeModal(document.getElementById('shipping-modal'));
                openModal(document.getElementById('online-payment-modal'));
            }
        });


        const openRatingModal = (productId) => {
            document.getElementById('rating-product-id').value = productId;
            const stars = document.querySelectorAll('#rating-stars .star');
            stars.forEach(star => star.classList.remove('selected'));
            currentRating = 0;
            document.getElementById('rating-review').value = '';
            openModal(document.getElementById('rating-modal'));
        };

        document.getElementById('rating-stars').addEventListener('click', e => {
            if (e.target.classList.contains('star')) {
                currentRating = parseInt(e.target.dataset.value);
                const stars = document.querySelectorAll('#rating-stars .star');
                stars.forEach((star, index) => {
                    star.classList.toggle('selected', index < currentRating);
                });
            }
        });

        document.getElementById('rating-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const productId = document.getElementById('rating-product-id').value;
            const review = document.getElementById('rating-review').value.trim();
            if (currentRating > 0 && review && currentUser) {
                const ratingRef = push(ref(db, `ratings/${productId}`));
                set(ratingRef, {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    rating: currentRating,
                    review: review,
                    active: false,
                    timestamp: Date.now()
                }).then(() => {
                    alert('Thank you for your review!');
                    closeModal(document.getElementById('rating-modal'));
                });
            } else {
                alert('Please provide a rating and a review.');
            }
        });

        const openUserChatModal = (order) => {
            currentChatOrder = order;
            const chatModal = document.getElementById('chat-modal');
            document.getElementById('chat-order-details').innerHTML = `Regarding Order: <b>#${order.displayOrderId}</b>`;
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = 'Loading chat...';

            const chatRef = ref(db, `chats/${order.orderId}`);
            onValue(chatRef, (snapshot) => {
                chatContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const chatData = snapshot.val();
                    if (chatData.messages) {
                        Object.values(chatData.messages).forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.classList.add('chat-message', msg.sender === 'user' ? 'user-message' : 'admin-message');
                            msgDiv.textContent = msg.text;
                            chatContainer.appendChild(msgDiv);
                        });
                    }
                } else {
                    chatContainer.innerHTML = '<p>Start the conversation.</p>';
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
            openModal(chatModal);
        };

        document.getElementById('send-message-btn').addEventListener('click', () => {
            const messageInput = document.getElementById('chat-message-input');
            const messageText = messageInput.value.trim();
            if (messageText && currentChatOrder) {
                const chatRef = ref(db, `chats/${currentChatOrder.orderId}`);
                const messageData = { sender: 'user', text: messageText, timestamp: Date.now() };

                get(chatRef).then(snapshot => {
                    if (snapshot.exists()) {
                        const messagesRef = ref(db, `chats/${currentChatOrder.orderId}/messages`);
                        push(messagesRef, messageData);
                        update(chatRef, { lastUpdated: Date.now(), isReadByAdmin: false });
                    } else {
                        set(chatRef, {
                            userId: currentUser.uid,
                            userEmail: currentUser.email,
                            displayOrderId: currentChatOrder.displayOrderId,
                            isReadByAdmin: false,
                            lastUpdated: Date.now(),
                            messages: [messageData]
                        });
                    }
                });
                messageInput.value = '';
            }
        });

        document.getElementById('theme-toggle').addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        });

        document.body.addEventListener('click', async e => {
            if(e.target.classList.contains('btn-copy')){
                const code = e.target.dataset.code;
                navigator.clipboard.writeText(code).then(() => {
                    e.target.textContent = 'Copied!';
                    setTimeout(() => { e.target.textContent = 'Copy Code'; }, 2000);
                });
            }
            else if (e.target.closest('.order-summary-item')) {
                const productId = e.target.closest('.order-summary-item').dataset.productId;
                if (productId) { location.hash = `#product-detail=${productId}`; }
            }
            else if (e.target.closest('.add-to-cart-btn')) { handleAddToCart(e.target.closest('[data-product-id]').dataset.productId); }
            else if (e.target.closest('.buy-now-btn')) { 
                const productId = e.target.closest('[data-product-id]').dataset.productId;
                const items = { [productId]: { quantity: 1 } };
                startCheckout(items);
            }
            else if (e.target.closest('.checkout-btn')) {
                const cartSnapshot = await get(userCartRef);
                startCheckout(cartSnapshot.val() || {});
            }
            else if (e.target.closest('.product-card-clickable')) { location.hash = `#product-detail=${e.target.closest('.product-card').dataset.productId}`; }
            else if (e.target.classList.contains('quantity-increase')) { updateCartQuantity(e.target.closest('.cart-item').dataset.productId, 1); }
            else if (e.target.classList.contains('quantity-decrease')) { updateCartQuantity(e.target.closest('.cart-item').dataset.productId, -1); }
            else if (e.target.id === 'add-new-address-btn') { openAddressModal(); }
            else if (e.target.classList.contains('edit-address-btn')) { openAddressModal(e.target.dataset.addressId); }
            else if (e.target.classList.contains('delete-address-btn')) { handleDeleteAddress(e.target.dataset.addressId); }
            else if (e.target.classList.contains('message-admin-btn')) {
                const orderId = e.target.dataset.orderId;
                const displayOrderId = e.target.dataset.displayOrderId;
                openUserChatModal({ orderId, displayOrderId });
            }
            else if (e.target.classList.contains('rate-product-btn')) {
                const productId = e.target.dataset.productId;
                openRatingModal(productId);
            }
        });

        document.getElementById('search-input').addEventListener('input', e => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const keywords = searchTerm.split(' ').filter(k => k); 

            if (keywords.length === 0) {
                renderProducts([], 'search-results-grid');
                return;
            }

            const filteredProducts = allProducts.filter(product => {
                const searchableText = [
                    product.name || '',
                    product.category || '',
                    product.description || ''
                ].join(' ').toLowerCase();

                return keywords.every(keyword => searchableText.includes(keyword));
            });
            renderProducts(filteredProducts, 'search-results-grid');
        });

        const openModal = (modal) => modal.classList.add('active');
        const closeModal = (modal) => modal.classList.remove('active');
        modals.forEach(modal => { modal.addEventListener('click', (e) => { if (e.target === modal || e.target.classList.contains('close-btn')) { closeModal(modal); } }); });
        document.getElementById('menu-btn').addEventListener('click', () => openModal(document.getElementById('menu-modal')));
    </script>
</body>
</html>